# =====================================================
# ğŸ§© 4 STAGES: base â†’ build â†’ publish â†’ final
# =====================================================

# -----------------------------------------------------
# ğŸ—ï¸ STAGE 1: Base runtime environment
# DÃ¹ng Ä‘á»ƒ CHáº Y app (chá»‰ cÃ³ .NET Runtime, khÃ´ng cÃ³ SDK)
# -----------------------------------------------------
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
WORKDIR /app
EXPOSE 80

# -----------------------------------------------------
# ğŸ§± STAGE 2: Build environment
# DÃ¹ng Ä‘á»ƒ BUILD mÃ£ nguá»“n (cÃ³ Ä‘áº§y Ä‘á»§ .NET SDK)
# -----------------------------------------------------
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src

COPY . .

WORKDIR /src/AuthService

# Copy file .csproj trÆ°á»›c Ä‘á»ƒ cache bÆ°á»›c restore
COPY ["AuthService.csproj", "."]

# Restore cÃ¡c dependency (NuGet packages)
RUN dotnet restore "AuthService.csproj"

# Copy toÃ n bá»™ source code vÃ o container
COPY . .

# Build project á»Ÿ cháº¿ Ä‘á»™ Release, output vÃ o /app/build
RUN dotnet build "AuthService.csproj" -c Release -o /app/build


# -----------------------------------------------------
# ğŸš€ STAGE 3: Publish app
# Xuáº¥t báº£n báº£n release cuá»‘i cÃ¹ng (tá»‘i Æ°u Ä‘á»ƒ deploy)
# -----------------------------------------------------
FROM build AS publish

# Publish app ra /app/publish, bá» host executable (Linux khÃ´ng cáº§n .exe)
RUN dotnet publish "AuthService.csproj" -c Release -o /app/publish /p:UseAppHost=false


# -----------------------------------------------------
# ğŸ§© STAGE 4: Final runtime image
# DÃ¹ng image nháº¹ (chá»‰ runtime) Ä‘á»ƒ cháº¡y app Ä‘Ã£ build
# -----------------------------------------------------
FROM base AS final
WORKDIR /app

# Copy káº¿t quáº£ publish tá»« stage trÆ°á»›c
COPY --from=publish /app/publish .

# Khi container khá»Ÿi Ä‘á»™ng â†’ cháº¡y app .NET
ENTRYPOINT [ "dotnet", "AuthService.dll" ]
